<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monsoon & Coriolis Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: system-ui, -apple-system, sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #0a0f1e;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            pointer-events: none; /* Let clicks pass through to map if needed, or handle here */
        }
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Custom Leaflet Dark Mode Adjustment */
        .leaflet-tile-pane {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3);
        }
        .leaflet-control-attribution {
            display: none !important;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="p-4 glass-panel z-30 flex justify-between items-center shadow-lg">
        <div>
            <h1 class="text-xl font-bold text-blue-400">Monsoon Simulator</h1>
            <p class="text-xs text-slate-400">Geography Interactive: Real-World Regional Wind Systems</p>
        </div>
        <div class="text-right hidden md:block">
            <span class="text-sm font-mono text-emerald-400" id="current-wind-status">Map Synchronized</span>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden">
        <!-- Map Container -->
        <div id="map"></div>

        <!-- Particle Canvas -->
        <canvas id="simulation-canvas"></canvas>

        <!-- Overlay UI Controls -->
        <div class="absolute top-4 left-4 z-30 w-72 flex flex-col gap-4 pointer-events-auto">
            
            <!-- Season Selector -->
            <div class="glass-panel p-4 rounded-xl shadow-xl">
                <label class="block text-sm font-medium mb-3 text-slate-300">Current Season</label>
                <div class="grid grid-cols-2 gap-2">
                    <button id="btn-sw" onclick="setSeason('SW')" class="py-2 px-3 rounded-lg text-sm font-bold bg-blue-600 hover:bg-blue-500 transition-colors">
                        SW Monsoon
                    </button>
                    <button id="btn-ne" onclick="setSeason('NE')" class="py-2 px-3 rounded-lg text-sm font-bold bg-slate-700 hover:bg-slate-600 transition-colors">
                        NE Monsoon
                    </button>
                </div>
                <p id="season-desc" class="mt-3 text-xs text-slate-400 leading-relaxed italic">
                    The land is warmer than the ocean, creating a regional low pressure over Asia.
                </p>
            </div>

            <!-- Physics Controls -->
            <div class="glass-panel p-4 rounded-xl shadow-xl">
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-sm font-medium text-slate-300">Coriolis Force</label>
                        <span id="coriolis-val" class="text-xs font-mono text-blue-400">1.0x</span>
                    </div>
                    <input type="range" id="range-coriolis" min="0" max="2" step="0.1" value="1" 
                           class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-slate-300">Show Pressure Cells</span>
                    <button id="toggle-pressure" class="w-10 h-5 bg-blue-600 rounded-full relative transition-colors">
                        <div class="absolute right-1 top-1 w-3 h-3 bg-white rounded-full transition-all" id="toggle-dot"></div>
                    </button>
                </div>
            </div>

            <!-- Learning Card -->
            <div id="learning-card" class="glass-panel p-4 rounded-xl shadow-xl border-l-4 border-emerald-500">
                <h3 class="text-sm font-bold text-emerald-400 mb-1 uppercase tracking-wider">Geographic Insight</h3>
                <p id="learning-text" class="text-xs text-slate-300">
                    Coriolis force deflects moving air to the right in the Northern Hemisphere, turning SE trades into SW monsoon winds.
                </p>
            </div>
        </div>

        <!-- Legend -->
        <div class="absolute bottom-6 right-4 z-30 flex flex-col gap-2 text-[10px] uppercase font-bold tracking-widest text-slate-300 glass-panel p-3 rounded-lg">
            <div class="flex items-center gap-2"><div class="w-3 h-3 bg-red-500 rounded-full"></div> Low Pressure (Asian Landmass)</div>
            <div class="flex items-center gap-2"><div class="w-3 h-3 bg-blue-500 rounded-full"></div> High Pressure (Oceanic/Siberian)</div>
            <div class="mt-1 border-t border-slate-700 pt-1 text-slate-500">Dashed line = Equator</div>
        </div>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const canvas = document.getElementById('simulation-canvas');
        const ctx = canvas.getContext('2d');
        const rangeCoriolis = document.getElementById('range-coriolis');
        const coriolisVal = document.getElementById('coriolis-val');
        const togglePressure = document.getElementById('toggle-pressure');
        const toggleDot = document.getElementById('toggle-dot');
        const seasonDesc = document.getElementById('season-desc');
        const learningText = document.getElementById('learning-text');

        let map, width, height;
        let particles = [];
        const particleCount = 250;
        let currentSeason = 'SW';
        let coriolisStrength = 1.0;
        let showPressure = true;

        // Realistic Lat/Lon coordinates for pressure centers
        const SEASONS = {
            'SW': {
                name: 'Southwest Monsoon',
                desc: 'Heating of the Asian landmass (Low) pulls moisture from the South Indian Ocean (High).',
                fact: 'Watch the winds cross the Equator and deflect right towards the Indian subcontinent.',
                btnActive: 'btn-sw',
                btnInactive: 'btn-ne',
                highCoord: [ -20, 70 ], // Mascarene High (Approx)
                lowCoord: [ 28, 77 ]    // NW India / Tibetan Low
            },
            'NE': {
                name: 'Northeast Monsoon',
                desc: 'Cold air sinks over Asia (High) and flows toward the warm equatorial oceans (Low).',
                fact: 'Winds flow from the Northeast. They are cool and dry as they originate over land.',
                btnActive: 'btn-ne',
                btnInactive: 'btn-sw',
                highCoord: [ 45, 90 ],  // Siberian High
                lowCoord: [ -10, 80 ]   // Equatorial Trough
            }
        };

        function initMap() {
            // Focus on South Asia / Indian Ocean
            map = L.map('map', {
                center: [15, 80],
                zoom: 4,
                zoomControl: false,
                dragging: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        class Particle {
            constructor() {
                this.reset();
            }

            reset() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = 0;
                this.vy = 0;
                this.life = Math.random() * 100 + 100;
                this.maxLife = this.life;
                this.history = [];
            }

            update() {
                const season = SEASONS[currentSeason];
                
                // Convert Lat/Lon targets to screen pixels
                const highPx = map.latLngToContainerPoint(season.highCoord);
                const lowPx = map.latLngToContainerPoint(season.lowCoord);

                // Pressure Gradient Force
                let dx = lowPx.x - this.x;
                let dy = lowPx.y - this.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                
                let forceX = (dx / dist) * 0.2;
                let forceY = (dy / dist) * 0.2;

                // Coriolis Logic
                // Find equator position in screen space
                const equatorPx = map.latLngToContainerPoint([0, 0]).y;
                
                // Strength varies by latitude distance from equator
                const latDiff = (equatorPx - this.y) / height;
                
                const corX = this.vy * 0.1 * coriolisStrength * latDiff;
                const corY = -this.vx * 0.1 * coriolisStrength * latDiff;

                this.vx += forceX + corX;
                this.vy += forceY + corY;

                this.vx *= 0.97;
                this.vy *= 0.97;

                this.x += this.vx;
                this.y += this.vy;

                this.history.push({x: this.x, y: this.y});
                if (this.history.length > 8) this.history.shift();

                this.life--;
                
                if (this.life <= 0 || this.x < 0 || this.x > width || this.y < 0 || this.y > height) {
                    this.reset();
                }
            }

            draw() {
                const opacity = (this.life / this.maxLife);
                ctx.beginPath();
                ctx.strokeStyle = currentSeason === 'SW' ? `rgba(100, 210, 255, ${opacity * 0.6})` : `rgba(220, 230, 255, ${opacity * 0.6})`;
                ctx.lineWidth = 1.5;
                if(this.history.length > 1) {
                    ctx.moveTo(this.history[0].x, this.history[0].y);
                    for(let p of this.history) ctx.lineTo(p.x, p.y);
                }
                ctx.stroke();

                ctx.fillStyle = currentSeason === 'SW' ? `rgba(180, 240, 255, ${opacity})` : `rgba(255, 255, 255, ${opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 1.2, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initSimulation() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            particles = [];
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
        }

        function setSeason(s) {
            currentSeason = s;
            const config = SEASONS[s];
            
            document.getElementById(config.btnActive).classList.replace('bg-slate-700', 'bg-blue-600');
            document.getElementById(config.btnInactive).classList.replace('bg-blue-600', 'bg-slate-700');
            
            seasonDesc.innerText = config.desc;
            learningText.innerText = config.fact;
        }

        function drawOverlays() {
            const equatorPx = map.latLngToContainerPoint([0, 0]).y;
            
            // Equator Line
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
            ctx.setLineDash([15, 15]);
            ctx.moveTo(0, equatorPx);
            ctx.lineTo(width, equatorPx);
            ctx.stroke();
            ctx.setLineDash([]);
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.font = '10px sans-serif';
            ctx.fillText('EQUATOR', 20, equatorPx - 8);

            if (showPressure) {
                const season = SEASONS[currentSeason];
                const highPx = map.latLngToContainerPoint(season.highCoord);
                const lowPx = map.latLngToContainerPoint(season.lowCoord);

                // Low Label
                ctx.shadowBlur = 15;
                ctx.shadowColor = 'rgba(239, 68, 68, 0.8)';
                ctx.fillStyle = '#f87171';
                ctx.font = 'bold 32px sans-serif';
                ctx.fillText('L', lowPx.x - 10, lowPx.y + 10);

                // High Label
                ctx.shadowColor = 'rgba(59, 130, 246, 0.8)';
                ctx.fillStyle = '#60a5fa';
                ctx.fillText('H', highPx.x - 10, highPx.y + 10);
                
                ctx.shadowBlur = 0;
            }
        }

        function animate() {
            // Partial clear for trails
            ctx.clearRect(0, 0, width, height);
            
            drawOverlays();

            particles.forEach(p => {
                p.update();
                p.draw();
            });

            requestAnimationFrame(animate);
        }

        // Listeners
        rangeCoriolis.addEventListener('input', (e) => {
            coriolisStrength = parseFloat(e.target.value);
            coriolisVal.innerText = coriolisStrength.toFixed(1) + 'x';
        });

        togglePressure.addEventListener('click', () => {
            showPressure = !showPressure;
            toggleDot.style.right = showPressure ? '4px' : 'auto';
            toggleDot.style.left = showPressure ? 'auto' : '4px';
            togglePressure.classList.toggle('bg-blue-600');
            togglePressure.classList.toggle('bg-slate-600');
        });

        window.addEventListener('resize', () => {
            initSimulation();
        });

        // Initialize everything
        window.onload = () => {
            initMap();
            initSimulation();
            animate();
            setSeason('SW');
        };
    </script>
</body>
</html>
