<div class="current-sim">
  <style>
    /* Scoped styles – only affect elements inside .current-sim */
    .current-sim {
      max-width: 720px;
      margin: 1.5rem auto;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      color: #111827;
    }

    .current-sim .quiz-container {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px 16px 16px;
      box-sizing: border-box;
    }

    .current-sim h3 {
      margin: 0 0 0.5rem;
      font-size: 1.05rem;
    }

    .current-sim .button-container {
      margin-top: 0.35rem;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .current-sim label {
      font-weight: 500;
    }

    .current-sim input[type="range"] {
      flex: 0 0 180px;
    }

    .current-sim button {
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid #2563eb;
      background: #2563eb;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }

    .current-sim button:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
    }

    .current-sim #latticeCanvas {
      background: #ffffff;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      margin-top: 10px;
      display: block;
      max-width: 100%;
      height: auto; /* responsive */
    }

    .current-sim .score {
      margin-top: 8px;
      font-size: 0.9rem;
    }

    .current-sim .sim-caption {
      margin-top: 4px;
      font-size: 0.85rem;
      color: #4b5563;
    }
  </style>

  <div class="quiz-container" id="lattice-sim">
    <h3>Metal Lattice Simulation</h3>

    <div class="button-container">
      <label for="sim-voltage">Voltage</label>
      <input type="range" id="sim-voltage" min="0" max="12" step="0.1" value="3">
      <span id="sim-voltage-label">3.0 V</span>
    </div>

    <div class="button-container">
      <label for="sim-temperature">Temperature</label>
      <input type="range" id="sim-temperature" min="0" max="100" value="20">
      <span id="sim-temperature-label">20 °C</span>
    </div>

    <div class="button-container" style="margin-top:10px;">
      <button id="sim-start">Start Field</button>
      <button id="sim-reset" type="button">Reset</button>
    </div>

    <div id="sim-stats" class="score">
      Mean drift speed: <span id="sim-mean">0.0</span> mm/s
    </div>
    <div id="sim-equation" class="sim-caption">
      At low temperature, ions vibrate less, so collisions are fewer and drift speed (and current) is higher for 3.0 V.
    </div>

    <canvas id="latticeCanvas"
            width="680"
            height="300">
      Your browser does not support the HTML5 canvas tag.
    </canvas>
  </div>

  <script>
    (function() {
      const root = document.getElementById('lattice-sim');
      if (!root) return;

      // DOM references scoped to this block
      const canvas = root.querySelector('#latticeCanvas');
      const ctx = canvas.getContext('2d');
      const vSlider = root.querySelector('#sim-voltage');
      const tSlider = root.querySelector('#sim-temperature');
      const vLabel = root.querySelector('#sim-voltage-label');
      const tLabel = root.querySelector('#sim-temperature-label');
      const meanLabel = root.querySelector('#sim-mean');
      const eqDiv = root.querySelector('#sim-equation');
      const startBtn = root.querySelector('#sim-start');
      const resetBtn = root.querySelector('#sim-reset');

      const W = canvas.width;
      const H = canvas.height;

      // Lattice setup
      const gridCols = 14, gridRows = 6;
      const cellW = W / (gridCols + 1);
      const cellH = H / (gridRows + 1);
      const lattice = [];

      for (let r = 0; r < gridRows; r++) {
        for (let c = 0; c < gridCols; c++) {
          lattice.push({
            x: (c + 1) * cellW,
            y: (r + 1) * cellH,
            phase: Math.random() * Math.PI * 2
          });
        }
      }

      const NUCLEUS_RADIUS = 8;
      const yMin = cellH * 0.5;
      const yMax = gridRows * cellH + cellH * 0.5;

      // Electrons
      const electrons = [];
      const electronCount = 60;

      function initElectrons() {
        electrons.length = 0;
        for (let i = 0; i < electronCount; i++) {
          electrons.push({
            x: Math.random() * W,
            y: yMin + Math.random() * (yMax - yMin),
            vx: 0,
            vy: 0
          });
        }
      }

      initElectrons();

      // Simulation state
      let running = false;
      let last = performance.now();
      let voltage = Number(vSlider.value);   // default 3 V
      let temperature = Number(tSlider.value); // default 20 °C

      const meanHistory = [];
      const meanWindow = 120;

      function updateExplanation() {
        if (!eqDiv) return;
        const v = voltage;
        const T = temperature;

        if (T < 30) {
          eqDiv.textContent =
            `At low temperature, ions vibrate less, so collisions are fewer and resistance is lower—drift speed (and current) is higher for ${v.toFixed(1)} V.`;
        } else if (T < 70) {
          eqDiv.textContent =
            `At moderate temperature, ion vibrations increase, so more collisions raise resistance and drift speed falls slightly for ${v.toFixed(1)} V.`;
        } else {
          eqDiv.textContent =
            `At high temperature, frequent collisions make resistance large, so drift speed (and current) drops for ${v.toFixed(1)} V.`;
        }
      }

      // Slider handlers
      vSlider.addEventListener('input', function() {
        voltage = Number(vSlider.value);
        vLabel.textContent = voltage.toFixed(1) + ' V';
        updateExplanation();
      });

      tSlider.addEventListener('input', function() {
        temperature = Number(tSlider.value);
        tLabel.textContent = temperature.toFixed(0) + ' °C';
        updateExplanation();
      });

      // Buttons
      startBtn.addEventListener('click', function() {
        running = !running;
        startBtn.textContent = running ? 'Pause Field' : 'Start Field';
      });

      resetBtn.addEventListener('click', function() {
        running = false;
        startBtn.textContent = 'Start Field';
        initElectrons();
        meanHistory.length = 0;
        meanLabel.textContent = '0.0';
        voltage = 3;
        temperature = 20;
        vSlider.value = '3';
        tSlider.value = '20';
        vLabel.textContent = '3.0 V';
        tLabel.textContent = '20 °C';
        updateExplanation();
      });

      function update(dt) {
        // Normalised temperature (0 at 20 °C, 1 at 100 °C)
        const tempNorm = Math.min(Math.max((temperature - 20) / 80, 0), 1);

        // Drift component and max speed reduce with temperature (more collisions)
        const drift = (voltage / 12) * 50 * (1 - 0.6 * tempNorm);
        const vMax = (voltage / 12) * 120 * (1 - 0.4 * tempNorm);

        // Update lattice ion positions (vibrations)
        for (const p of lattice) {
          const amp = 3 + tempNorm * 8;
          const phaseSpeed = 0.03 + tempNorm * 0.12;
          p.phase += phaseSpeed;
          p.jx = p.x + Math.sin(p.phase) * amp;
          p.jy = p.y + Math.cos(p.phase * 1.3) * amp;
        }

        // Update electrons
        const nucleusRadius = NUCLEUS_RADIUS;
        for (const e of electrons) {
          if (running) {
            e.vx += drift * dt;
          } else {
            // Gentle damping when paused
            e.vx *= 0.95;
            e.vy *= 0.95;
          }

          e.x += e.vx * dt;
          e.y += e.vy * dt;

          // Collisions with vibrating ions
          for (const p of lattice) {
            const cx = p.jx || p.x;
            const cy = p.jy || p.y;
            const dx = e.x - cx;
            const dy = e.y - cy;
            const r = nucleusRadius + 2.5;
            const d2 = dx * dx + dy * dy;

            if (d2 < r * r) {
              const d = Math.max(1e-6, Math.sqrt(d2));
              const nx = dx / d;
              const ny = dy / d;

              // Push electron just outside the ion
              e.x = cx + nx * r;
              e.y = cy + ny * r;

              // Reflect with some loss
              const vn = e.vx * nx + e.vy * ny;
              e.vx -= 1.2 * vn * nx;
              e.vy -= 1.2 * vn * ny;

              // Random thermal "kick" stronger at higher T
              const a = Math.random() * Math.PI * 2;
              const s = 20 * tempNorm;
              e.vx += Math.cos(a) * s;
              e.vy += Math.sin(a) * s;

              // Reduce speed a bit after collision, more at high T
              const speedFactor = 0.8 - 0.3 * tempNorm;
              e.vx *= speedFactor;
              e.vy *= speedFactor;
            }
          }

          // Wrap horizontally (like a long wire)
          if (e.x < 0) e.x += W;
          if (e.x > W) e.x -= W;

          // Bounce vertically between top and bottom of lattice region
          if (e.y < yMin) {
            e.y = yMin;
            e.vy *= -0.4;
          }
          if (e.y > yMax) {
            e.y = yMax;
            e.vy *= -0.4;
          }

          // Clamp maximum speed
          const sp = Math.hypot(e.vx, e.vy);
          if (sp > vMax && vMax > 0) {
            const k = vMax / sp;
            e.vx *= k;
            e.vy *= k;
          }
        }

        // Mean drift speed along +x
        const instMean = electrons.reduce((s, e) => s + e.vx, 0) / electrons.length;
        meanHistory.push(instMean);
        if (meanHistory.length > meanWindow) meanHistory.shift();

        const smoothMean = meanHistory.reduce((s, v) => s + v, 0) / (meanHistory.length || 1);
        const displayedMean = Math.max(0, Math.min(smoothMean, vMax)); // clamp to [0, vMax]
        meanLabel.textContent = displayedMean.toFixed(1);
      }

      function draw() {
        ctx.clearRect(0, 0, W, H);

        // Draw ions (metal lattice)
        const nucleusRadius = NUCLEUS_RADIUS;
        ctx.lineWidth = 1;

        for (const p of lattice) {
          ctx.beginPath();
          ctx.arc(p.jx || p.x, p.jy || p.y, nucleusRadius, 0, Math.PI * 2);
          ctx.strokeStyle = '#9ca3af';
          ctx.stroke();
          ctx.fillStyle = '#d1d5db';
          ctx.fill();
        }

        // Draw electrons
        ctx.fillStyle = '#1e88e5';
        for (const e of electrons) {
          ctx.beginPath();
          ctx.arc(e.x, e.y, 2.5, 0, Math.PI * 2);
          ctx.fill();
        }

        // Simple voltage bar indicator (top left)
        ctx.fillStyle = '#d32f2f';
        const barWidth = Math.min(200, (voltage / 12) * 200);
        ctx.fillRect(10, 12, barWidth, 6);
      }

      function loop(now) {
        const dt = Math.min(0.05, (now - last) / 1000);
        last = now;
        update(dt);
        draw();
        window.requestAnimationFrame(loop);
      }

      // Initial explanation text
      updateExplanation();
      window.requestAnimationFrame(loop);
    })();
  </script>
</div>